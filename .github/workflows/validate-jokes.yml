name: Validate Jokes

on:
  pull_request:
    paths:
      - 'jokes/jokes.json'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Check JSON syntax
        run: node -e "JSON.parse(require('fs').readFileSync('jokes/jokes.json','utf8'))"

      - name: Validate against schema
        run: npm run validate:check

      - name: Check for duplicate joke IDs
        run: |
          node -e "
            const jokes = JSON.parse(require('fs').readFileSync('jokes/jokes.json', 'utf8'));
            const ids = jokes.map(j => j.id);
            const duplicates = ids.filter((id, i) => ids.indexOf(id) !== i);
            if (duplicates.length > 0) {
              console.error('Duplicate joke IDs found:', duplicates);
              process.exit(1);
            }
            console.log('No duplicate joke IDs found.');
          "

      - name: Post validation results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let jokes;
            let status = 'âœ… All checks passed';
            let summary = '';

            try {
              jokes = JSON.parse(fs.readFileSync('jokes/jokes.json', 'utf8'));
              const categories = {};
              for (const joke of jokes) {
                categories[joke.category] = (categories[joke.category] || 0) + 1;
              }
              const breakdown = Object.entries(categories)
                .map(([cat, count]) => `  - **${cat}**: ${count}`)
                .join('\n');

              summary = `### ğŸƒ Joke Validation Results\n\n` +
                `**Total jokes**: ${jokes.length}\n\n` +
                `**Category breakdown**:\n${breakdown}\n\n`;
            } catch (e) {
              status = 'âŒ Validation failed';
              summary = `### ğŸƒ Joke Validation Results\n\n` +
                `**Error**: Could not parse jokes.json\n\n`;
            }

            if ('${{ job.status }}' !== 'success') {
              status = 'âŒ Validation failed';
            }

            summary += `**Status**: ${status}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
